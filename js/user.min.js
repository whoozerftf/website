const toast=document.getElementById("toast"),usernameInput=document.getElementById("usernameInput"),emailInput=document.getElementById("emailInput"),phoneInput=document.getElementById("phoneInput"),profilePic=document.getElementById("userPhoto"),uploadPic=document.getElementById("uploadPic"),editBtn=document.getElementById("editBtn"),saveBtn=document.getElementById("saveBtn"),logoutBtn=document.getElementById("logoutBtn");let currentUser=null;function toggleMenu(){document.querySelector(".nav-links").classList.toggle("active")}feather.replace();const openCartBtn=document.getElementById("openCart"),closeCartBtn=document.getElementById("closeCart"),cartSidebar=document.getElementById("cartSidebar"),cartItemsEl=document.getElementById("cartItems"),cartTotalEl=document.getElementById("cartTotal"),checkoutBtn=document.getElementById("checkoutBtn"),cart=JSON.parse(localStorage.getItem("cart"))||[];function updateCart(){cartItemsEl.innerHTML="";let t=0;cart.forEach((e,a)=>{t+=e.price*e.qty,cartItemsEl.innerHTML+=`<div class="cart-item"><h4>${e.name}</h4><p>Size: ${e.size?e.size:"-"}</p><p>Rp ${e.price.toLocaleString("id-ID")} x ${e.qty}</p><div class="qty-control"><button class="qty-btn" onclick="changeQty(${a}, -1)">-</button><span>${e.qty}</span><button class="qty-btn" onclick="changeQty(${a}, 1)">+</button></div></div>`}),cartTotalEl.textContent=t.toLocaleString("id-ID"),localStorage.setItem("cart",JSON.stringify(cart))}function changeQty(t,e){cart[t].qty+=e,cart[t].qty<=0&&cart.splice(t,1),updateCart()}window.onload=()=>{updateCart()},window.changeQty=changeQty,document.querySelectorAll(".add-cart-btn").forEach(t=>{t&&t.addEventListener("click",()=>{const e=t.closest(".product-card"),a=e.getAttribute("data-name"),n=parseInt(e.getAttribute("data-price")),o=cart.find(t=>t.name===a);o?o.qty+=1:cart.push({name:a,price:n,qty:1}),updateCart(),cartSidebar.classList.add("active")})}),openCartBtn.addEventListener("click",()=>cartSidebar.classList.add("active")),closeCartBtn.addEventListener("click",()=>cartSidebar.classList.remove("active"));const sidebar=document.getElementById("mobileSidebar"),openBtn=document.getElementById("mobileMenuBtn"),closeBtn=document.getElementById("closeSidebar");openBtn.addEventListener("click",function(t){t.stopPropagation(),sidebar.classList.add("active")}),closeBtn.addEventListener("click",function(){sidebar.classList.remove("active")}),document.addEventListener("click",function(t){sidebar.classList.contains("active")&&!sidebar.contains(t.target)&&t.target!==openBtn&&!openBtn.contains(t.target)&&sidebar.classList.remove("active")});function showToast(t,e=!1){toast.textContent=t,toast.style.background=e?"#e74c3c":"#2ecc71",toast.classList.add("show"),setTimeout(()=>toast.classList.remove("show"),3e3)}window.auth.onAuthStateChanged(async t=>{if(!t)return void(window.location.href="login.html");if(!t.emailVerified)return alert("Silakan verifikasi email Anda terlebih dahulu."),await window.auth.signOut(),void(window.location.href="login.html");currentUser=t,emailInput.value=t.email||"",t.displayName&&(usernameInput.value=t.displayName),t.phoneNumber&&(phoneInput.value=t.phoneNumber);try{const e=window.db.collection("users").doc(t.uid),a=await e.get();if(a.exists){const e=a.data();e.username&&(usernameInput.value=e.username),e.email&&(emailInput.value=e.email),e.phone&&(phoneInput.value=e.phone),e.photoURL&&(profilePic.src=e.photoURL)}}catch(t){console.error("Error fetching user data:",t)}}),uploadPic.addEventListener("change",async()=>{const t=uploadPic.files[0];if(t&&currentUser){const e=new FormData;e.append("file",t),e.append("upload_preset","profile_upload"),e.append("folder","whoozer/profile_photos");try{const t=await fetch("https://api.cloudinary.com/v1_1/dzcicmbh2/image/upload",{method:"POST",body:e}),a=await t.js?v=4"on();if(a.secure_url){const t=window.db.collection("users").doc(currentUser.uid);await t.set({photoURL:a.secure_url},{merge:!0}),profilePic.src=a.secure_url,showToast("Foto profil berhasil diunggah.")}else throw new Error("Upload gagal")}catch(t){console.error("Upload error:",t),showToast("Gagal mengunggah foto.",!0)}}}),editBtn.addEventListener("click",()=>{usernameInput.disabled=!1,emailInput.disabled=!1,phoneInput.disabled=!1,saveBtn.style.display="inline",editBtn.style.display="none"}),saveBtn.addEventListener("click",async()=>{if(currentUser){const t=usernameInput.value.trim(),e=emailInput.value.trim(),a=phoneInput.value.trim();[usernameInput,emailInput,phoneInput].forEach(t=>t.classList.remove("error")),t||(usernameInput.classList.add("error"),showToast("Username tidak boleh kosong.",!0));if(!emailInput.classList.contains("error")&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))return emailInput.classList.add("error"),void showToast("Email tidak valid.",!0);if(!phoneInput.classList.contains("error")&&!/^\d*$/.test(a))return phoneInput.classList.add("error"),void showToast("Nomor HP hanya boleh angka.",!0);try{const n=window.db.collection("users").doc(currentUser.uid);await n.set({username:t,email:e,phone:a},{merge:!0}),showToast("Profil berhasil diperbarui."),usernameInput.disabled=!0,emailInput.disabled=!0,phoneInput.disabled=!0,saveBtn.style.display="none",editBtn.style.display="inline"}catch(t){console.error("Gagal menyimpan:",t),showToast("Terjadi kesalahan saat menyimpan.",!0)}}});const logoutBtnProfile=document.getElementById("logoutBtnProfile");logoutBtnProfile&&logoutBtnProfile.addEventListener("click",async function(){try{await window.auth.signOut(),showToast("Berhasil logout."),setTimeout(()=>{window.location.href="login.html"},1e3)}catch(t){console.error("Logout error:",t),showToast("Gagal logout.",!0)}});
